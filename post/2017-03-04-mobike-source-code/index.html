<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="aZ679hf2Rw"><title> 摩拜单车爬虫源码及解析 · 我是思聪</title><meta name="description" content="摩拜单车爬虫源码及解析 - 贺思聪"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.april1985.com/atom.xml" title="我是思聪"><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-129409069-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129409069-1');
</script>


<script>
  (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();
  </script></head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">我是思聪</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>现在</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>曾经</p></a><ul class="shortcut-icons"><a href="https://github.com/derekhe" target="_blank"><img src="/images/github.svg" class="icon"></a><a href="/atom.xml" target="_blank"><img src="/images/rss.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">摩拜单车爬虫源码及解析</h1><div class="post-info">Mar 4, 2017</div><div class="post-content"><p>前两篇文章分析了我为什么抓取摩拜单车的接口以及数据分析的结果，这篇文章中讲直接提供可运行的源代码供学习。</p>
<blockquote>
<p>声明：<br>此爬虫仅用于学习、研究用途，请不要用于非法用途。任何由此引发的法律纠纷自行负责。</p>
</blockquote>
<p>没耐心看文章的请后直接：</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">git clone http<span class="variable">s:</span>//github.<span class="keyword">com</span>/derekhe/mobike-crawler</span><br><span class="line"><span class="keyword">python3</span> crawler.<span class="keyword">py</span></span><br></pre></td></tr></table></figure>

<p>爽了以后请别忘了给个star和打赏！</p>
<h1 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h1><ul>
<li>\analysis - jupyter做数据分析</li>
<li>\influx-importer - 导入到influxdb，但之前没怎么弄好</li>
<li>\modules - 代理模块</li>
<li>\web - 实时图形化显示模块，当时只是为了学一下react而已，效果请见<a href="www.april1985.com/mobike">这里</a></li>
<li>crawler.py - 爬虫核心代码</li>
<li>importToDb.py - 导入到postgres数据库中进行分析</li>
<li>sql.sql - 创建表的sql</li>
<li>start.sh -　持续运行的脚本</li>
</ul>
<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>核心代码放在crawler.py中，数据首先存储在sqlite3数据库中，然后去重复后导出到csv文件中以节约空间。</p>
<p>摩拜单车的API返回的是一个正方形区域中的单车，我只要按照一块一块的区域移动就能抓取到整个大区域的数据。</p>
<p>left,top,right,bottom定义了抓取的范围，目前是成都市绕城高速之内以及南至南湖的正方形区域。offset定义了抓取的间隔，现在以0.002为基准，在DigitalOcean 5$的服务器上能够15分钟内抓取一次。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">    left = <span class="number">30.7828453209</span></span><br><span class="line">    top = <span class="number">103.9213455517</span></span><br><span class="line">    right = <span class="number">30.4781772402</span></span><br><span class="line">    bottom = <span class="number">104.2178123382</span></span><br><span class="line"></span><br><span class="line">    offset = <span class="number">0.002</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> os.path.isfile(self.db_name):</span><br><span class="line">        os.remove(self.db_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> sqlite3.connect(self.db_name) <span class="keyword">as</span> c:</span><br><span class="line">            c.execute(<span class="string">'''CREATE TABLE mobike</span></span><br><span class="line"><span class="string">                (Time DATETIME, bikeIds VARCHAR(12), bikeType TINYINT,distId INTEGER,distNum TINYINT, type TINYINT, x DOUBLE, y DOUBLE)'''</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> ex:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>然后就启动了250个线程，至于你要问我为什么没有用协程，哼哼～～我当时没学～～～其实是可以的，说不定效率更高。</p>
<p>由于抓取后需要对数据进行去重，以便消除小正方形区域之间重复的部分，最后的group_data正是做这个事情。</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">executor = ThreadPoolExecutor(max_workers=<span class="number">250</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">"Start"</span>)</span></span></span><br><span class="line">self<span class="selector-class">.total</span> = <span class="number">0</span></span><br><span class="line">lat_range = np.arange(<span class="attribute">left</span>, right, -offset)</span><br><span class="line"><span class="keyword">for</span> lat <span class="keyword">in</span> lat_range:</span><br><span class="line">    lon_range = np.arange(<span class="attribute">top</span>, bottom, offset)</span><br><span class="line">    <span class="keyword">for</span> lon <span class="keyword">in</span> lon_range:</span><br><span class="line">        self<span class="selector-class">.total</span> += <span class="number">1</span></span><br><span class="line">        executor.submit(self<span class="selector-class">.get_nearby_bikes</span>, (lat, lon))</span><br><span class="line"></span><br><span class="line">executor.shutdown()</span><br><span class="line">self.group_data()</span><br></pre></td></tr></table></figure>

<p>最核心的API代码在这里。小程序的API接口，搞几个变量就可以了，十分简单。</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">def get_nearby_bikes(self, <span class="keyword">args</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        url = <span class="string">"https://mwx.mobike.com/mobike-api/rent/nearbyBikesInfo.do"</span></span><br><span class="line"></span><br><span class="line">        payload = <span class="string">"latitude=%s&amp;longitude=%s&amp;errMsg=getMapCenterLocation"</span> % (<span class="keyword">args</span>[<span class="number">0</span>], <span class="keyword">args</span>[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">'charset'</span>: <span class="string">"utf-8"</span>,</span><br><span class="line">            <span class="string">'platform'</span>: <span class="string">"4"</span>,</span><br><span class="line">            <span class="string">"referer"</span>:<span class="string">"https://servicewechat.com/wx40f112341ae33edb/1/"</span>,</span><br><span class="line">            <span class="string">'content-type'</span>: <span class="string">"application/x-www-form-urlencoded"</span>,</span><br><span class="line">            <span class="string">'user-agent'</span>: <span class="string">"MicroMessenger/6.5.4.1000 NetType/WIFI Language/zh_CN"</span>,</span><br><span class="line">            <span class="string">'host'</span>: <span class="string">"mwx.mobike.com"</span>,</span><br><span class="line">            <span class="string">'connection'</span>: <span class="string">"Keep-Alive"</span>,</span><br><span class="line">            <span class="string">'accept-encoding'</span>: <span class="string">"gzip"</span>,</span><br><span class="line">            <span class="string">'cache-control'</span>: <span class="string">"no-cache"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        self.request(headers, payload, <span class="keyword">args</span>, url)</span><br><span class="line">    except Exception <span class="keyword">as</span> <span class="keyword">ex</span>:</span><br><span class="line">        <span class="keyword">print</span>(<span class="keyword">ex</span>)</span><br></pre></td></tr></table></figure>

<p>最后你可能要问频繁的抓取IP没有被封么？其实摩拜单车是有IP的访问速度限制的，只不过破解之道非常简单，就是用大量的代理。</p>
<p>我是有一个代理池，每天基本上有8000以上的代理。在ProxyProvider中直接获取到这个代理池然后提供一个pick函数用于随机选取得分前50的代理。请注意，我的代理池是每小时更新的，但是代码中提供的jsonblob的代理列表仅仅是一个样例，过段时间后应该大部分都作废了。</p>
<p>在这里用到一个代理得分的机制。我并不是直接随机选择代理，而是将代理按照得分高低进行排序。每一次成功的请求将加分，而出错的请求将减分。这样一会儿就能选出速度、质量最佳的代理。如果有需要还可以存下来下次继续用。</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyProvider</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, min_proxies=<span class="number">200</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>._bad_proxies = &#123;&#125;</span><br><span class="line">        <span class="keyword">self</span>._minProxies = min_proxies</span><br><span class="line">        <span class="keyword">self</span>.lock = threading.RLock()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.get_list()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_list</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        logger.debug(<span class="string">"Getting proxy list"</span>)</span><br><span class="line">        r = requests.get(<span class="string">"https://jsonblob.com/31bf2dc8-00e6-11e7-a0ba-e39b7fdbe78b"</span>, timeout=<span class="number">10</span>)</span><br><span class="line">        proxies = ujson.decode(r.text)</span><br><span class="line">        logger.debug(<span class="string">"Got %s proxies"</span>, len(proxies))</span><br><span class="line">        <span class="keyword">self</span>._proxies = list(map(lambda <span class="symbol">p:</span> Proxy(p), proxies))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pick</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        with <span class="keyword">self</span>.<span class="symbol">lock:</span></span><br><span class="line">            <span class="keyword">self</span>._proxies.sort(key = lambda <span class="symbol">p:</span> p.score, reverse=True)</span><br><span class="line">            proxy_len = len(<span class="keyword">self</span>._proxies)</span><br><span class="line">            max_range = <span class="number">50</span> <span class="keyword">if</span> proxy_len &gt; <span class="number">50</span> <span class="keyword">else</span> proxy_len</span><br><span class="line">            proxy = <span class="keyword">self</span>._proxies[random.randrange(<span class="number">1</span>, max_range)]</span><br><span class="line">            proxy.used()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> proxy</span><br></pre></td></tr></table></figure>

<p>在实际使用中，通过proxyProvider.pick()选择代理，然后使用。如果代理出现任何问题，则直接用proxy.fatal_error()降低评分，这样后续就不会选择到这个代理了。</p>
<figure class="highlight zephir"><table><tr><td class="code"><pre><span class="line">def request(<span class="keyword">self</span>, headers, payload, args, url):</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        proxy = <span class="keyword">self</span>.proxyProvider.pick()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = requests.request(</span><br><span class="line">                <span class="string">"POST"</span>, url, data=payload, headers=headers,</span><br><span class="line">                proxies=&#123;<span class="string">"https"</span>: proxy.url&#125;,</span><br><span class="line">                timeout=<span class="number">5</span>,verify=<span class="keyword">False</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            with <span class="keyword">self</span>.lock:</span><br><span class="line">                with sqlite3.connect(<span class="keyword">self</span>.db_name) <span class="keyword">as</span> c:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        <span class="keyword">print</span>(response.text)</span><br><span class="line">                        decoded = ujson.decode(response.text)[<span class="string">'object'</span>]</span><br><span class="line">                        <span class="keyword">self</span>.done += <span class="number">1</span></span><br><span class="line">                        <span class="keyword">for</span> x in decoded:</span><br><span class="line">                            c.execute(<span class="string">"INSERT INTO mobike VALUES (%d,'%s',%d,%d,%s,%s,%f,%f)"</span> % (</span><br><span class="line">                                <span class="keyword">int</span>(time.time()) * <span class="number">1000</span>, x[<span class="string">'bikeIds'</span>], <span class="keyword">int</span>(x[<span class="string">'biketype'</span>]), <span class="keyword">int</span>(x[<span class="string">'distId'</span>]),</span><br><span class="line">                                x[<span class="string">'distNum'</span>], x[<span class="string">'type'</span>], x[<span class="string">'distX'</span>],</span><br><span class="line">                                x[<span class="string">'distY'</span>]))</span><br><span class="line"></span><br><span class="line">                        timespend = datetime.datetime.now() - <span class="keyword">self</span>.start_time</span><br><span class="line">                        percent = <span class="keyword">self</span>.done / <span class="keyword">self</span>.total</span><br><span class="line">                        total = timespend / percent</span><br><span class="line">                        <span class="keyword">print</span>(args, <span class="keyword">self</span>.done, percent * <span class="number">100</span>, <span class="keyword">self</span>.done / timespend.total_seconds() * <span class="number">60</span>, total,</span><br><span class="line">                              total - timespend)</span><br><span class="line">                    except <span class="keyword">Exception</span> <span class="keyword">as</span> ex:</span><br><span class="line">                        <span class="keyword">print</span>(ex)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        except <span class="keyword">Exception</span> <span class="keyword">as</span> ex:</span><br><span class="line">            proxy.fatal_error()</span><br></pre></td></tr></table></figure>

<p>好了，基本上就到此了～～～其他的代码自己研究吧～～～</p>
</div></article></div></div></main><footer class="footer-container"><div class="paginator"><a href="/post/2017-05-24-freelancer-analysis/" class="prev">PREV</a><a href="/post/2017-02-12-mobike-api-analysis/" class="next">NEXT</a></div><div class="copyright"><p>© 2008 - 2019 <a href="http://www.april1985.com">贺思聪</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer><script>var _mtac = {}; (function() {     var mta = document.createElement("script"); mta.src = "http://pingjs.qq.com/h5/stats.js?v2.0.2";    mta.setAttribute("name", "MTAH5");    mta.setAttribute("sid", "500490740");    var s = document.getElementsByTagName("script")[0];    s.parentNode.insertBefore(mta, s);})();</script></body></html>