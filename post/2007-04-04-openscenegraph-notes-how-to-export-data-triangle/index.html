<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="aZ679hf2Rw"><title> OpenSceneGraph 笔记--如何导出三角形数据 · 我是思聪</title><meta name="description" content="OpenSceneGraph 笔记--如何导出三角形数据 - 贺思聪"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.april1985.com/atom.xml" title="我是思聪"><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-129409069-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-129409069-1');
</script>


<script>
  (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();
  </script></head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">我是思聪</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>现在</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>曾经</p></a><ul class="shortcut-icons"><a href="https://github.com/derekhe" target="_blank"><img src="/images/github.svg" class="icon"></a><a href="/atom.xml" target="_blank"><img src="/images/rss.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">OpenSceneGraph 笔记--如何导出三角形数据</h1><div class="post-info">Apr 4, 2007</div><div class="post-content"><p>在OpenSceneGraph开发中，为了方便会经常使用到一些不是三角形片的数据，比如四边形等数据。例如画一个管子用四边形带比用三角形片好计算得多。比如现在我们要画一个由两个平面组成的面，我可以这样做：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">osg::Geode* geode=<span class="keyword">new</span> osg::Geode;</span><br><span class="line">osg::Geometry* polyGeom = <span class="keyword">new</span> osg::Geometry;</span><br><span class="line">osg::Vec3 myCoords[]=</span><br><span class="line">&#123;</span><br><span class="line">osg::Vec3(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>),</span><br><span class="line">osg::Vec3(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>),</span><br><span class="line">osg::Vec3(<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>),</span><br><span class="line">osg::Vec3(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>),</span><br><span class="line">osg::Vec3(<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>),</span><br><span class="line">osg::Vec3(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> numCoords = <span class="keyword">sizeof</span>(myCoords)/<span class="keyword">sizeof</span>(osg::Vec3);</span><br><span class="line">osg::Vec3Array* vertices = <span class="keyword">new</span> osg::Vec3Array(numCoords,myCoords);</span><br><span class="line">polyGeom-&gt;setVertexArray(vertices);</span><br><span class="line">polyGeom-&gt;addPrimitiveSet(<span class="keyword">new</span> osg::DrawArrays(osg::PrimitiveSet::QUAD_STRIP,<span class="number">0</span>,numCoords));</span><br><span class="line">geode-&gt;addDrawable(polyGeom);</span><br></pre></td></tr></table></figure>

<p>这样就用6个点，用OpenGL提供的QUAD_STRIP方式画出了两个平面。<br>但是如果要把这个平面用于碰撞检测等技术，那么就需要把这六个点所表示的四边形带转换成三角形片才行。这些三角形定点如下：</p>
<figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="symbol">0 </span><span class="number">1</span> <span class="number">0</span></span><br><span class="line"><span class="symbol">0 </span><span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="symbol">1 </span><span class="number">1</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">0 </span><span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="symbol">1 </span><span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="symbol">1 </span><span class="number">1</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">1 </span><span class="number">1</span> <span class="number">0</span></span><br><span class="line"><span class="symbol">1 </span><span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="symbol">2 </span><span class="number">1</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">1 </span><span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="symbol">2 </span><span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="symbol">2 </span><span class="number">1</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>可以看出两个平面由4个三角形组成，而且都是逆时针排列(朝向一致)。<br>以前我自己做过转换，但是感觉很麻烦。OpenSceneGraph的Example osggeometry中提供了一个printTriangles函数，它可以打印出一个drawable所有的三角形片，不管最初的数据结构如何：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NormalPrint</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span> <span class="params">(<span class="keyword">const</span> osg::Vec3&amp; v1,<span class="keyword">const</span> osg::Vec3&amp; v2,<span class="keyword">const</span> osg::Vec3&amp; v3, <span class="keyword">bool</span>)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">osg::Vec3 normal = (v2-v1)^(v3-v2);</span><br><span class="line">normal.normalize();</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"t("</span>&lt;&lt;&lt;<span class="string">") ("</span>&lt;&lt;&lt;<span class="string">") ("</span>&lt;&lt;&lt;<span class="string">") "</span>&lt;&lt;<span class="string">") normal ("</span>&lt;&lt;&lt;<span class="string">")"</span>&lt;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// decompose Drawable primtives into triangles, print out these triangles and computed normals.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printTriangles</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name, osg::Drawable&amp; drawable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;</span><br><span class="line"></span><br><span class="line">osg::TriangleFunctor tf;</span><br><span class="line">drawable.accept(tf);</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span>&lt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心的思想就是利用osg::TriangleFunctor这个模版。这个模版会让你重载()运算符，然后让Drawable去visit它。在这个过程中，所有原始的数据(不管是三角形片的，还是四边形的)都转换成了三角形片数据。</p>
<p>那么如何把三角形数据导出哪？只需要修改一下借助这个思路，将NormalPrint修改成我们需要的就对了。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">GetVertex</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span> <span class="params">(<span class="keyword">const</span> osg::Vec3&amp; v1,<span class="keyword">const</span> osg::Vec3&amp; v2,<span class="keyword">const</span> osg::Vec3&amp; v3, <span class="keyword">bool</span>)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">vertexList-&gt;push_back(v1);</span><br><span class="line">vertexList-&gt;push_back(v2);</span><br><span class="line">vertexList-&gt;push_back(v3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">osg::Vec3Array* vertexList;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getTriangles</span><span class="params">(osg::Drawable&amp; drawable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">osg::TriangleFunctor tf;</span><br><span class="line">tf.vertexList=<span class="keyword">new</span> osg::Vec3Array;</span><br><span class="line"></span><br><span class="line">drawable.accept(tf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(osg::Vec3Array::iterator itr=tf.vertexList-&gt;begin();</span><br><span class="line">itr!=tf.vertexList-&gt;end();</span><br><span class="line">itr++)</span><br><span class="line">&#123;</span><br><span class="line">osg::Vec3 vertex=*itr;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span>&lt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下是完整的示例文件：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// PrimitiveSet.cpp : 定义控制台应用程序的入口点。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">GetVertex</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span> <span class="params">(<span class="keyword">const</span> osg::Vec3&amp; v1,<span class="keyword">const</span> osg::Vec3&amp; v2,<span class="keyword">const</span> osg::Vec3&amp; v3, <span class="keyword">bool</span>)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">vertexList-&gt;push_back(v1);</span><br><span class="line">vertexList-&gt;push_back(v2);</span><br><span class="line">vertexList-&gt;push_back(v3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">osg::Vec3Array* vertexList;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getTriangles</span><span class="params">(osg::Drawable&amp; drawable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">osg::TriangleFunctor tf;</span><br><span class="line">tf.vertexList=<span class="keyword">new</span> osg::Vec3Array;</span><br><span class="line"></span><br><span class="line">drawable.accept(tf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(osg::Vec3Array::iterator itr=tf.vertexList-&gt;begin();</span><br><span class="line">itr!=tf.vertexList-&gt;end();</span><br><span class="line">itr++)</span><br><span class="line">&#123;</span><br><span class="line">osg::Vec3 vertex=*itr;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span>&lt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">osg::<span class="function">Node* <span class="title">createGeode</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">osg::Geode* geode=<span class="keyword">new</span> osg::Geode;</span><br><span class="line">osg::Geometry* polyGeom = <span class="keyword">new</span> osg::Geometry;</span><br><span class="line">osg::Vec3 myCoords[]=</span><br><span class="line">&#123;</span><br><span class="line">osg::Vec3(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>),</span><br><span class="line">osg::Vec3(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>),</span><br><span class="line">osg::Vec3(<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>),</span><br><span class="line">osg::Vec3(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>),</span><br><span class="line">osg::Vec3(<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>),</span><br><span class="line">osg::Vec3(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> numCoords = <span class="keyword">sizeof</span>(myCoords)/<span class="keyword">sizeof</span>(osg::Vec3);</span><br><span class="line">osg::Vec3Array* vertices = <span class="keyword">new</span> osg::Vec3Array(numCoords,myCoords);</span><br><span class="line">polyGeom-&gt;setVertexArray(vertices);</span><br><span class="line">polyGeom-&gt;addPrimitiveSet(<span class="keyword">new</span> osg::DrawArrays(osg::PrimitiveSet::QUAD_STRIP,<span class="number">0</span>,numCoords));</span><br><span class="line">geode-&gt;addDrawable(polyGeom);</span><br><span class="line">getTriangles(*polyGeom);</span><br><span class="line"><span class="keyword">return</span> geode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> _tmain(<span class="keyword">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//Set up viewer</span></span><br><span class="line">osgViewer::Viewer viewer;</span><br><span class="line">osg::ref_ptr traits=<span class="keyword">new</span> osg::GraphicsContext::Traits;</span><br><span class="line">traits-&gt;x=<span class="number">200</span>;</span><br><span class="line">traits-&gt;y=<span class="number">200</span>;</span><br><span class="line">traits-&gt;width=<span class="number">800</span>;</span><br><span class="line">traits-&gt;height=<span class="number">600</span>;</span><br><span class="line">traits-&gt;windowDecoration=<span class="literal">true</span>;</span><br><span class="line">traits-&gt;doubleBuffer=<span class="literal">true</span>;</span><br><span class="line">traits-&gt;sharedContext=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">osg::ref_ptr gc=osg::GraphicsContext::createGraphicsContext(traits.get());</span><br><span class="line">osg::ref_ptr camera=<span class="keyword">new</span> osg::Camera;</span><br><span class="line"><span class="comment">//osg::Camera camera=new osg::Camera;</span></span><br><span class="line">camera-&gt;setGraphicsContext(gc.get());</span><br><span class="line">camera-&gt;setViewport(<span class="keyword">new</span> osg::Viewport(<span class="number">0</span>,<span class="number">0</span>,traits-&gt;width,traits-&gt;height));</span><br><span class="line">camera-&gt;setDrawBuffer(GL_BACK);</span><br><span class="line">camera-&gt;setReadBuffer(GL_BACK);</span><br><span class="line">osgGA::TrackballManipulator* tm=<span class="keyword">new</span> osgGA::TrackballManipulator;</span><br><span class="line"></span><br><span class="line">viewer.setCameraManipulator(tm);</span><br><span class="line"></span><br><span class="line">viewer.addSlave(camera.get());</span><br><span class="line"></span><br><span class="line"><span class="comment">//Set up root node</span></span><br><span class="line">osg::ref_ptr root=<span class="keyword">new</span> osg::Group;</span><br><span class="line"></span><br><span class="line">root-&gt;addChild(createGeode());</span><br><span class="line"></span><br><span class="line"><span class="comment">//Start show!</span></span><br><span class="line">viewer.setSceneData(root.get());</span><br><span class="line">viewer.realize();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(!viewer.done())</span><br><span class="line">&#123;</span><br><span class="line">viewer.frame();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div></div></main><footer class="footer-container"><div class="paginator"><a href="/post/2007-04-05-too-much-bad-google-input-method/" class="prev">PREV</a><a href="/post/2007-04-04-openscenegraph-notes-the-world-is-so-beautiful/" class="next">NEXT</a></div><div class="copyright"><p>© 2008 - 2019 <a href="http://www.april1985.com">贺思聪</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer><script>var _mtac = {}; (function() {     var mta = document.createElement("script"); mta.src = "http://pingjs.qq.com/h5/stats.js?v2.0.2";    mta.setAttribute("name", "MTAH5");    mta.setAttribute("sid", "500490740");    var s = document.getElementsByTagName("script")[0];    s.parentNode.insertBefore(mta, s);})();</script></body></html>